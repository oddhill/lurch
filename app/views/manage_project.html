<h1>Change <span class="title-name"></span> settings</h1>

<div id="project">
  <form id="change-project">
    <div class="input">
      <label>Name:</label>
      <input type="text" name="name" />
    </div>
    <div class="input">
      <label>Path:</label>
      <span class="path"></span>
      <!--<input type="file" name="path" nwdirectory />-->
    </div>

    <input type="submit" value="Save" />
    <input type="button" class="delete-project" value="Delete" />
  </form>
</div>

<h2>Plugins</h2>
<div id="project-plugins">
  <ul>

  </ul>
</div>

<script>
  var projects = require('./lib/projects.js');
  var plugins = require('./lib/plugins.js');
  var mainMenu = require('./lib/menu.js');

  var projectPath = null;
  var projectPlugins = null;

  // Get specific project
  projects.get(projectEditId, function(project) {
    // Load data
    $('#change-project').find('input[name="name"]').val(project[0].name);
    $('.title-name').text(project[0].name);
    $('.path').text(project[0].path);
    projectPath = project[0].path;
    var projectPlugins = [];
    for (var key in project[0].plugins) {
      projectPlugins.push(project[0].plugins[key].id);
    }

    // Get plugins
    var checked = null;
    plugins.getPlugins(function(_plugins) {

      // Append plugins
      for (var key in _plugins) {
        // Check if plugin in enabled on current project
        checked = null;
        if ($.inArray(_plugins[key]._id, projectPlugins) > -1) {
          checked = 'checked';
        }

        $('#project-plugins ul').append('<li>' + _plugins[key].name + '<span class="checkbox"><input type="checkbox" data-id="' + _plugins[key]._id + '"' + checked + ' /></span></li>');
      }

      // Edit db on change
      $('#project-plugins input[type="checkbox"]').on('change', function() {
        var add = $(this).prop('checked');
        var id = $(this).attr('data-id');

        var pluginAddData = { id: id, used: 0 };

        var update = { $pull: { plugins: { id: id } } };

        if (add) {
          update = { $push: { plugins: pluginAddData } };
        }

        projects.updatePlugins(projectEditId, update, function() {
          // Rebuild menu
          mainMenu.destroy(function() {
            mainMenu.populate();
            plugins.buildMostUsedMenu();
            plugins.rebuildMenu();
          });
        });

    });
  });

  });

  $('#change-project').submit(function(event) {
    event.preventDefault();

    if ($('#change-project').find('input[name="path"]').val()) {
      projectPath = $('#change-project').find('input[name="path"]').val();
    }

    var query = {
      name: $(this).find('input[name="name"]').val(),
      path: projectPath,
      plugins: ['eHkK0rnJdZSfK8k8'],
    };

    projects.update(projectEditId, query, function() {
      $('#app').load('views/manage_projects.html');
    });
  });

  $('.delete-project').click(function(event) {
    event.preventDefault();

    projects.remove(projectEditId, function() {
      projects.rebuildMenu();
      $('#app').load('views/manage_projects.html');
    });
  });
</script>