<h1>Change <span class="title-name"></span> settings</h1>

<div id="project">
  <form id="change-project">
    <div class="input">
      <label>Name:</label>
      <input type="text" name="name" />
    </div>
    <div class="input">
      <label>Path:</label>
      <span class="path"></span>
      <!--<input type="file" name="path" nwdirectory />-->
    </div>

    <input type="submit" value="Save" />
    <input type="button" class="delete-project" value="Delete" />
  </form>
</div>

<h2>Plugins</h2>
<div id="project-plugins">
  <ul>

  </ul>
</div>

<script>
  var Project = require('./lib/Project/Project.js');
  var Plugin = require('./lib/Plugin/Plugin.js');

  var projectPath = null;
  var projectPlugins = null;

  var _project = null;

  // Form element
  var $name = $('#change-project').find('input[name="name"]');

  // Get specific project
  Project.findById(projectEditId, function(err, project) {
    _project = project;
    // Load data
    $name.val(project.name);
    $('.title-name').text(project.name);
    $('.path').text(project.path);

    var projectPlugins = null;
    project.getPlugins(function(_projectPlugins) {
      projectPlugins = _projectPlugins;
    });

    // Get plugins
    var checked = null;
    Plugin.findAll(function(err, plugins) {
      // Append plugins
      for (var key in plugins) {
        // Check if plugin in enabled on current project
        checked = null;
        for (var key2 in projectPlugins) {
          if (plugins[key]._id == projectPlugins[key2].id) {
            checked = 'checked';
          }
        }

        $('#project-plugins ul').append('<li>' + plugins[key].name + '<span class="checkbox"><input type="checkbox" data-id="' + plugins[key]._id + '"' + checked + ' /></span></li>');
      }

      // Edit db on change
      $('#project-plugins input[type="checkbox"]').on('change', function() {

        var add = $(this).prop('checked');
        var id = $(this).attr('data-id');

        // Remove or add plugin from project
        if (add) {
          projectPlugins.push({ id: id, used: 0 });
          project.setPlugins(projectPlugins);
        } else {
          for (var i = 0; i < projectPlugins.length; i++) {
            if (projectPlugins[i].id === id) {
              projectPlugins.splice(i, 1);
              project.setPlugins(projectPlugins);
              break;
            }
          }
        }

        // Save to db
        project.save(function() {
          // Rebuild menu
          nwMenu.rebuild();
        });
      });
    });
  });

  $('#change-project').submit(function(event) {
    event.preventDefault();

    // Update project
    _project.setName($name.val());
    _project.save(function(err) {
      if (!err) {
        // Rebuild menu
        nwMenu.rebuild();
        $('#app').load('views/add_projects.html');
      }
    });
  });

  $('.delete-project').click(function(event) {
    event.preventDefault();

    // Remove project
    _project.remove(function(err) {
      if (!err) {
        // Rebuild menu
        nwMenu.rebuild();
        $('#app').load('views/add_projects.html');
      }
    });
  });
</script>
